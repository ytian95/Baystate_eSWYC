<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-header-panel/paper-header-panel.html">           
            
<dom-module id="result-page">
    <link rel="import" type="css" href="result-page.css">
    <template>
        <paper-header-panel id="header" mode="seamed">
            <paper-toolbar>
                <div id="headerName">Patient's Result <span>{{age}}</span> months</div>
            </paper-toolbar>
        </paper-header-panel>
        <paper-card class="section" heading="Developmental Milestones" elevation="3">
  			<div class="card-content">
  				<paper-button id ="dmstatus">Developmental Milestones Score: <span>{{dmscore}}</span>
  				</paper-button>			
  				<br/>
        		<canvas id="canvas"></canvas>
        		<br/>
        	</div>
		</paper-card>
		
		<paper-card class="positiveQ" heading="Very Much (score:2)" elevation="3">
  			<div class="card-content" id="dmQ2"></div>
		</paper-card>
		
		<paper-card class="positiveQ" heading="Some What (score:1)" elevation="3">
  			<div class="card-content" id="dmQ1"></div>
		</paper-card>
		
        <paper-card class="section" heading="Baby Pediatric Symptom Checklist" elevation="3">
  			<div class="card-content">
    		<paper-button id ="irritability">Irritability: <span>{{bpscscore.0}}</span>
        	</paper-button>
    		<paper-button id ="inflexibility">Inflexibility: <span>{{bpscscore.1}}</span>
        	</paper-button>
        	<paper-button id ="difficulty">Difficulty with Routines: <span>{{bpscscore.2}}
        	</span></paper-button>
  			</div>
		</paper-card>
    
    
    </template>
    <script>

        Polymer({
            is: 'result-page',
        	properties: {
            	version: {
                	type: Number,
                	notify: true,
            	},   
            	age: {
            		type: Number,
            		notify: true,
            		value: 2,
            	},  
            	scaleRatio: {
            		type: Number,
            		value: 60,
            	},        	
            	scoreScaleTable: {
                	type: Object,
                	notify: true,
                	value: {"2": [14, 15],
                			"3": [17, 17],
                			"4": [14, 16],
                			"5": [16, 17],
                			"6": [12, 16],
                			"7": [15, 18],
                			"8": [17, 19],
                			"9": [12, 15],
                			"10": [14, 17],
                			"11": [15, 17],
                			"12": [13, 16],
                			"13": [14, 17],
                			"14": [15, 18],
                			"15": [11, 17],
                			"16": [13, 17],
                			"17": [14, 18],
                			"18": [9, 16],
                			"19": [11, 17],
                			"20": [12, 17],
                			"21": [14, 18],
                			"22": [15, 18],
                			"23": [11, 17],
                			"24": [12, 17],
                			"25": [13, 18],
                			"26": [14, 18],
                			"27": [15, 18],
                			"28": [16, 18],
                			"29": [10, 17],
                			"30": [11, 17],
                			"31": [12, 18],
                			"32": [13, 18],
                			"33": [14, 18],
                			"34": [14, 19],
                			"35": [11, 17],
                			"36": [12, 17],
                			"37": [13, 17],
                			"38": [14, 17],
                			"39": [14, 18],
                			"40": [15, 18],
                			"41": [15, 18],
                			"42": [16, 18],
                			"43": [16, 18],
                			"44": [17, 18],
                			"45": [17, 19],
                			"46": [17, 19],
                			"47": [13, 17],
                			"48": [14, 17],
                			"49": [14, 17],
                			"50": [14, 18],
                			"51": [15, 18],
                			"52": [15, 18],
                			"53": [15, 18],
                			"54": [16, 18],
                			"55": [16, 18],
                			"56": [16, 18],
                			"57": [16, 18],
                			"58": [17, 19],
                			"59": [15, 18],
                			"60": [15, 18],
                			"61": [16, 18],
                			"62": [16, 18],
                			"63": [16, 18],
                			"64": [16, 19],
                			"65": [17, 19],
                			"66": [17, 19],
                			"67": [17, 19],
                			"68": [17, 19],
                			"69": [18, 19],
                			"70": [18, 19],
                			},
                },  
                dmQuestions: {
                    type: Array,
                    notify: true,
                    value: [],
                },
                dmAnswers: {
                    type: Array,
                    notify: true,
                    value: [],
                },
                dmscore: {
                	type: Number,
                	notify: true,
                	value: 0,
                	observer: '_scoreChanged',
                },
                bpscscore: {
                	type: Array,
                	notify: true,
                	value: [0,0,0],
                	observer: '_scoreChanged',
                }, 
                       		
        	},
        	drawdmBar: function(value, aveLow, aveUpper, g){
        			g.fillStyle = "#de2b41";
					g.fillRect(30, 50, 2.7*this.scaleRatio,30); 
    				g.fill();
    				g.fillStyle = "#0fa955";
					g.fillRect(30 + 2.7*this.scaleRatio, 50, 
						4.6*this.scaleRatio,30);
    				g.fill();
    				g.fillStyle = "#1a8926";
					g.fillRect(30 + 7.3*this.scaleRatio, 50,
						 2.7*this.scaleRatio,30);
    				g.fill();  

    				g.fillStyle = "white";
					g.font = "14px Arial";
					g.fillText("Below Average", 30 + 35 ,70);
					g.fillText("Average",30 + 95 + 2.7*this.scaleRatio,70);
					g.fillText("Above Average",35 + 30 + 7.3*this.scaleRatio,70);
					g.fillStyle = "black";
					g.fillText("0", 30 - 5, 95);
					g.fillText(aveLow.toString(),30 - 5 + 2.7*this.scaleRatio,95);
					g.fillText(aveUpper.toString(),30 - 5+ 7.3*this.scaleRatio,95);
					g.fillText("20",30 - 5 +10*this.scaleRatio,95);
						
					var markPosition;
					if(this.dmscore < aveLow){	
						markPosition= (this.dmscore/aveLow)*2.7;
					} else if(aveLow <= this.dmscore && this.dmscore <= aveLow){
						markPosition= ((this.dmscore-aveLow)/(aveUpper-aveLow))*4.6 + 2.7;
					} else{
						markPosition= ((this.dmscore-aveUpper)/(20-aveLow))*2.7 + 7.3;
					};
					g.beginPath();							
					g.moveTo(30+markPosition*this.scaleRatio,30);
					g.lineTo(30+markPosition*this.scaleRatio,90);
					g.lineWidth = 2;
					g.stroke();
					if(this.dmscore !== 0 && this.dmscore !== 20 && 
						this.dmscore !== aveLow && this.dmscore !== aveUpper){
						g.fillText(this.dmscore.toString(),
							30 - 5 +markPosition*this.scaleRatio,105);
					};
        	},
        	updatedmstatus: function(lowCutoff){
				if(this.dmscore >= lowCutoff){
    				this.$$('#dmstatus').style.background = "#0fa955";
    			} else {
    	    		this.$$('#dmstatus').style.background = "#de2b41";
    			};        	
        	},
        	layoutPostiveQuestions: function(){
        		var question2Container = this.$$('#dmQ2');
        		question2Container.innerHTML = "";
        		for( var i = 0; i<this.dmAnswers.length; i++){
        			if(this.dmAnswers[i] == 2){
        				var question2 = document.createTextNode(this.dmQuestions[i]);
                    	question2Container.appendChild(question2);
                    	question2Container.appendChild(document.createElement("br"));
        			};
        		}
        		
        		var question1Container = this.$$('#dmQ1');
        		question1Container.innerHTML = "";
        		for( var i = 0; i<this.dmAnswers.length; i++){
        			if(this.dmAnswers[i] == 1){
        				var question1 = document.createTextNode(this.dmQuestions[i]);
                    	question1Container.appendChild(question1);
                    	question1Container.appendChild(document.createElement("br"));
        			};
        		}
        	},
        	updatebpscstatus: function(){
        		if(this.bpscscore[0] < 3){
    				this.$$('#irritability').style.background = "#0fa955";
    			} else {
    	    		this.$$('#irritability').style.background = "#de2b41";
				};
				if(this.bpscscore[1] < 3){
    				this.$$('#inflexibility').style.background = "#0fa955";
    			} else {
    	    		this.$$('#inflexibility').style.background = "#de2b41";
				};
				if(this.bpscscore[2] < 3){
    				this.$$('#difficulty').style.background = "#0fa955";
    			} else {
    	    		this.$$('#difficulty').style.background = "#de2b41";
				};
        	},
        	_scoreChanged: function(){
        		if(this.bpscscore == undefined){
        			this.bpscscore = [0,0,0]; 
        		};
        		var canvas = this.$$('#canvas');
        		canvas.width = innerWidth;
        		canvas.height = 110;
				var g = canvas.getContext("2d");
				
				var scoreScale = this.scoreScaleTable[this.age.toString()];
				var lowCutoff = scoreScale[0];
				var upCutoff = scoreScale[1];
    			this.drawdmBar(this.dmscore, lowCutoff, upCutoff, g);  				
				this.updatedmstatus(lowCutoff);
				this.layoutPostiveQuestions();
				
				this.updatebpscstatus();
				
        	},
        	
        });
    </script>
</dom-module>