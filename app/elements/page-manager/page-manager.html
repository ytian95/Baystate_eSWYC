<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../dev-page/dev-page.html">
<link rel="import" href="../bpsc-page/bpsc-page.html">
<link rel="import" href="../family-page/family-page.html">
<link rel="import" href="../emotional-page/emotional-page.html">
<link rel="import" href="../posi-page/posi-page.html">
<link rel="import" href="../page-login/page-login.html">
<link rel="import" href="../result-page/result-page.html">
    
<dom-module id="page-manager">
    <link rel="import" type="css" href="page-manager.css">
    <template>
        <!--<paper-header-panel mode="seamed">
            <paper-toolbar>
                <div id="headerName">eSWYC<span>{{title}}</span></div>
            </paper-toolbar>
        </paper-header-panel>-->
        <iron-pages selected="{{pageNum}}" id="ironPage">
            <div>
                <page-login version="{{version}}" is-valid="{{inputValid}}"
                	age="{{age}}"></page-login>
            </div>
            <div>
                <dev-page version="{{version}}" section="dev milestones"></dev-page>
            </div>
            
            <div>
                <bpsc-page version="{{version}}"></bpsc-page>
            </div>
                        
            <div id="result">
                <result-page age="{{age}}" version="{{version}}" dmscore="{{dmscore}}" 
                	bpscscore="{{bpscscore}}" pcscore="{{pcscore}}" 
                	familyscore="{{familyscore}}"></result-page>
            </div>
            
        </iron-pages>
        <br>
        <div><paper-button raised on-click="back" id="back">Back</paper-button></div>
        <div><paper-button raised on-click="next" id="next">
        	Next</paper-button></div>
        <div><paper-button raised on-click="submit" id="submit">Submit</paper-button>
        </div>
        <iron-ajax
            auto
            url="/questions.json"
            handle-as="json"
            on-response="handleResponse">
        </iron-ajax>
        <?php include('../../scripts/answer.php') ?>
        <!--
        <iron-ajax
        	auto = "ture"
    		method="POST"
    		url="../../scripts/answer.php"
    		params=''
    		handle-as="json"
    		on-response="handleResponse"></iron-ajax>-->
    </template>
    <script>
    	var jsonOfQuestions ="";
        Polymer({
            is: 'page-manager',
            properties: {
                title: {
                    type: String,
                    notify: true,
                    value: ": 2 month"
                },
                pageNum: {
                    type: Number,
                    notify: true,
                    value: 0,
                    observer: '_pageChange',
                },
                version: {
                    type: Number,
                    notify: true,
                    observer: 'pullSections',
                },
                age: {
                    type: Number,
                    notify: true,
                },
                inputValid: {
                	type: Boolean,
                	notify: true,
                	value: false,
                	observer: '_pageChange',
                },
                dmscore: {
                	type: Number,
                	notify: true,
                	value: 0,
                },
                bpscscore: {
                	type: Array,
                	notify: true,
                	value: [0,0,0],
                },
                pcscore: {
                	type: Number,
                	notify: true,
                	value: 0,
                },
                familyscore: {
                	type: Array,
                	notify: true,
                	value: [0,0,0],
                },
                sectionKeys: {
                	type: Array,
                	notify: true,
                },
            },
            next: function(){
                var pages = document.querySelector('iron-pages');
                pages.selectNext();
            },
            handleResponse: function (data) {
                jsonOfQuestions= data.detail.response;       
            },
            pullSections: function (data) {
               if (this.version){
                    swycAge=(String(this.version)).concat(" month");
                    var questions = jsonOfQuestions[swycAge]["questions"];
                    this.sectionKeys = Object.keys(questions);
                    console.log(this.sectionKeys);
                    var pageContainer = Polymer.dom(this.$.ironPage);
                    var lastPageNode = this.$.result;
                    if(this.sectionKeys.indexOf("Parent’s Concerns") > -1){
                    	var pPage = document.createElement('dev-page');
                    	pPage.section = "Parent’s Concerns";
                    	pPage.version = this.version;
                    	var newDiv = document.createElement('div');
                    	newDiv.appendChild(pPage);
                    	pageContainer.insertBefore(newDiv, lastPageNode);
                    };
                    if(this.sectionKeys.indexOf("Family Questions") > -1){
                    	var fPage = document.createElement('family-page');
                    	fPage.version = this.version;
                    	var newDiv = document.createElement('div');
                    	newDiv.appendChild(fPage);
                    	pageContainer.insertBefore(newDiv, lastPageNode);
                    };
                    if(this.sectionKeys.indexOf("Emotional Changes With A New Baby") > -1){
                    	var ePage = document.createElement('emotional-page');
                    	ePage.version = this.version;
                    	var newDiv = document.createElement('div');
                    	newDiv.appendChild(ePage);
                    	pageContainer.insertBefore(newDiv, lastPageNode);
    	            };
    	            var posiName = "Parent’s Observation of Social Interactions (POSI)";  
                    if(this.sectionKeys.indexOf(posiName) > -1){
                    	var ePage = document.createElement('posi-page');
                    	ePage.version = this.version;
                    	var newDiv = document.createElement('div');
                    	newDiv.appendChild(ePage);
                    	pageContainer.insertBefore(newDiv, lastPageNode);
    	            };                  
                }         
            },
            back: function(){
                var pages = document.querySelector('iron-pages');
                pages.selectPrevious();
            },
            _pageChange: function(){
                var pageTotal = document.querySelector("iron-pages").items.length;
                if(this.pageNum === 0){
                    this.$$("#back").style.display = 'none';
                    this.$$("#submit").style.display = 'none';
                    if(this.inputValid === false){
                    	this.$$("#next").disabled = true;
                    	this.$$("#next").style.backgroundColor = "grey";
                    } else {
                    	this.$$("#next").style.backgroundColor = "#0aae55";
                    	this.$$("#next").disabled = false;
                    };
                }else if(this.pageNum === (pageTotal - 2)){
                    this.$$("#next").style.display = 'none';
                    this.$$("#submit").style.display = 'inline-block';
                }else if(this.pageNum === (pageTotal - 1)){
                    this.$$("#submit").style.display = 'none';                    
                }else{
                    this.$$("#back").style.display = 'inline-block';
                    this.$$("#next").style.display = 'inline-block';
                    this.$$("#submit").style.display = 'none';
                };
            },
            submit: function() {
            	//flip page
                var pages = document.querySelector('iron-pages');
                pages.selectNext();
                
                
                var devquestions = document.querySelectorAll("dev-page")[0].questions;
                document.querySelector("result-page").dmQuestions = devquestions;
            	var devAnswers = document.querySelectorAll("dev-page")[0].answers;
            	document.querySelector("result-page").dmAnswers = devAnswers;
            	
            	var bpscquestions = document.querySelector("bpsc-page").questions;
                document.querySelector("result-page").bpscQuestions = bpscquestions;
            	var bpscAnswers = document.querySelector("bpsc-page").answers;

				var pcAnswers = [];
                if(this.sectionKeys.indexOf("Parent’s Concerns") > -1){
                	var pcquestions = document.querySelectorAll("dev-page")[1].questions;
                	document.querySelector("result-page").pcQuestions = pcquestions;
            		pcAnswers = document.querySelectorAll("dev-page")[1].answers;
            		document.querySelector("result-page").pcAnswers = pcAnswers;
            	};
            	
            	var familyAnswers =[];
                if(this.sectionKeys.indexOf("Family Questions") > -1){
                	var familyQuestions = document.querySelector("family-page").questions;
                	document.querySelector("result-page").familyQuestions = 
                		familyQuestions;
            		familyAnswers = document.querySelector("family-page").answers;
            		document.querySelector("result-page").familyAnswers = familyAnswers;
            	};
                if(this.sectionKeys.indexOf("Emotional Changes With A New Baby") > -1){
                	var emoQuestions = document.querySelector("emotional-page").questions;
                	document.querySelector("result-page").emoQuestions = 
                		emoQuestions;
            		var emoAnswers = document.querySelector("emotional-page").answers;
            		document.querySelector("result-page").emoAnswers = emoAnswers;  
    	        };
    	        var posiName = "Parent’s Observation of Social Interactions (POSI)";  
                if(this.sectionKeys.indexOf(posiName) > -1){
                	var posiQuestions = document.querySelector("posi-page").questions;
                	document.querySelector("result-page").emoQuestions = 
                		posiQuestions;
            		var posiAnswers = document.querySelector("posi-page").answers;
            		document.querySelector("result-page").posiAnswers = posiAnswers;
    	        };  

            	
            	/*var answerHashMap = {};
            	answerHashMap["dev"] = devAnswers;
            	answerHashMap["bpsc"] = bpscAnswers;
            	*/
          	
            	var devTotalScore = 0;
            	for( var i = 0; i < devAnswers.length; i++){
            		if(devAnswers[i] === -1 || devAnswers[i] === undefined ){
            			// skip a question            		
            		} else {
            			devTotalScore += Number(devAnswers[i]);
            		};
            	};
            	
            	var bpscTotalScore = [0,0,0];
            	if(this.age < 18) {
            		for( var i = 0; i < 4; i++){
            			if(bpscAnswers[i] === -1 || bpscAnswers[i] === undefined ){
            				bpscAnswers[i] = -1;
            			} else {
            				bpscTotalScore[0] += Number(bpscAnswers[i]);
            			};
            		};
            		for( var i = 4; i < 8; i++){
            			if(bpscAnswers[i] === -1 || bpscAnswers[i] === undefined ){
            				bpscAnswers[i] = -1;
            			} else {
            				bpscTotalScore[1] += Number(bpscAnswers[i]);
            			};
            		};
            		for( var i = 8; i < 12; i++){
            			if(bpscAnswers[i] === -1 || bpscAnswers[i] === undefined ){
            				bpscAnswers[i] = -1;
            			} else {
            				bpscTotalScore[2] += Number(bpscAnswers[i]);
            			};
            		};
            	} else {
            		for( var i = 0; i < bpscAnswers.length; i++){
            			if(bpscAnswers[i] === -1 || bpscAnswers[i] === undefined ){
            				bpscAnswers[i] = -1;
            			} else {
            				bpscTotalScore[0] += Number(bpscAnswers[i]);
            			};
            		};
            	};
            	//the answers need to pass to result page before the score since the  
            	//scoreChanged in the result-page will be triggered.
            	document.querySelector("result-page").bpscAnswers = bpscAnswers;

            	var pcTotalScore = 0;
            	for( var i = 0; i < pcAnswers.length; i++){
            		if(pcAnswers[i] === -1 || pcAnswers[i] === undefined ){
            			// skip a question            		
            		} else {
            			pcTotalScore += Number(pcAnswers[i]);
            		};
            	};
            	
            	var familyTotalScore = [0,0,0];
            	if(familyAnswers.length !== 0) {
            		for( var i = 0; i < 5; i++){
            			if(familyAnswers[i] === -1 || familyAnswers[i] === undefined ){
            				// skip a question            		
            			} else {
            				familyTotalScore[0] += Number(familyAnswers[i]);
            			};
            		};
            		for( var i = 5; i < 7; i++){
            			if(familyAnswers[i] === -1 || familyAnswers[i] === undefined ){
            				// skip a question            		
            			} else {
            				familyTotalScore[1] += Number(familyAnswers[i]);
            			};
            		};
            	};
            	if(familyAnswers.length > 7) {
            		for( var i = 7; i < 9; i++){
            			if(familyAnswers[i] === -1 || familyAnswers[i] === undefined ){
            				// skip a question            		
            			} else {
            				familyTotalScore[2] += Number(familyAnswers[i]);
            			};
            		};
            	}; 
            	            	
            	this.dmscore = devTotalScore;
            	this.bpscscore = bpscTotalScore;
            	this.pcscore = pcTotalScore;
            	this.familyscore = familyTotalScore;
            	
            	//alert("Development Milestone Score : " + devTotalScore.toString() + "\n" 
            		//+ "Baby Pediatric Symptom Checklist Score : " 
            		//+ bpscTotalScore.toString());
            		
				/*var a = [1,2,3];
    			var xmlhttp = new XMLHttpRequest();
				xmlhttp.open( "POST", "../../scripts/answer.php", true );
				xmlhttp.setRequestHeader( "Content-Type", "application/json" );
				xmlhttp.send( '[1,2,3]' ); 
				
				
				var a = [1,2,3];
				var ajax = document.querySelector('iron-ajax');
				ajax.contentType = 'application/json';
				ajax.params = JSON.stringify(a);
				*/
				
			
            },
        });
    </script>
</dom-module>